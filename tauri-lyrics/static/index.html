<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8" />
    <title>Misuzu Lyrics Helper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,
      body {
        background: transparent;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }
      main {
        width: 100vw;
        height: 100vh;
        background: transparent;
        pointer-events: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #lyrics-canvas {
        width: 100vw;
        height: 100vh;
        display: block;
        background: transparent;
      }
    </style>
  </head>
  <body>
    <main data-tauri-drag-region>
      <canvas id="lyrics-canvas"></canvas>
    </main>
    <script type="module">
      const canvas = document.getElementById('lyrics-canvas');
      const ctx = canvas?.getContext('2d');
      const DEFAULT_LINE = '歌词加载中';
      let currentLine = DEFAULT_LINE;

      if (!canvas || !ctx) {
        const fallback = document.createElement('div');
        fallback.textContent = DEFAULT_LINE;
        fallback.style.cssText = `
          font-size: 26px;
          font-weight: 700;
          color: #ffffff;
          text-align: center;
          width: 100%;
          pointer-events: auto;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        `;
        document.body.innerHTML = '';
        document.body.appendChild(fallback);
        console.error('无法初始化 Canvas 渲染环境');
      } else {
        const resizeCanvas = () => {
          const dpr = window.devicePixelRatio || 1;
          const width = window.innerWidth;
          const height = window.innerHeight;

          canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;
        canvas.width = Math.max(1, Math.floor(width * dpr));
        canvas.height = Math.max(1, Math.floor(height * dpr));

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);

        return { width, height };
        };

        const drawLine = (text = '—') => {
          const { width, height } = resizeCanvas();
          ctx.clearRect(0, 0, width, height);

          const content = text || '—';
          const maxWidth = width * 0.82;
          let fontSize = Math.min(width, height) * 0.14;
          fontSize = Math.max(fontSize, 20);

          const fontStack = "'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif";
          const setFont = () => {
            ctx.font = `900 ${fontSize}px ${fontStack}`;
          };

          setFont();
          while (ctx.measureText(content).width > maxWidth && fontSize > 28) {
            fontSize -= 2;
            setFont();
          }

          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.lineJoin = 'round';
          ctx.lineCap = 'round';

          ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
          ctx.shadowBlur = fontSize * 0.16;

          ctx.lineWidth = Math.max(fontSize * 0.08, 2.5);
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.95)';
          ctx.strokeText(content, width / 2, height / 2);

          ctx.shadowBlur = fontSize * 0.05;
          ctx.fillStyle = '#ffffff';
          ctx.fillText(content, width / 2, height / 2);
        };

        const resolveLine = (payload) => {
          const text = payload?.active_line?.trim();
          return text && text.length ? text : DEFAULT_LINE;
        };

        const render = (payload) => {
          currentLine = resolveLine(payload);
          drawLine(currentLine);
        };

        const registerExitShortcuts = (tauri) => {
          const handler = (event) => {
            const key = event.key?.toLowerCase();
            const comboPressed = event.metaKey || event.ctrlKey;
            const exitViaQ = comboPressed && key === 'q';
            const exitViaEsc = comboPressed && key === 'escape';

            if (exitViaQ || exitViaEsc) {
              event.preventDefault();
              tauri.invoke('exit_app');
            }
          };

          window.addEventListener('keydown', handler);
        };

        async function init() {
          try {
            const tauri = await import('tauri://api');
            drawLine(currentLine);
            const payload = await tauri.invoke('get_lyrics_state');
            render(payload);

            await tauri.event.listen('lyrics:update', ({ payload }) => {
              render(payload);
            });

            registerExitShortcuts(tauri);
          } catch (error) {
            console.error('初始化 Tauri 接口失败:', error);
            drawLine(DEFAULT_LINE);
          }
        }

        window.addEventListener('resize', () => drawLine(currentLine));
        init();
      }
    </script>
  </body>
</html>

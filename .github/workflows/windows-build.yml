name: Build Windows ZIP and Installer

on:
  workflow_call:
    inputs:
      version:
        description: Target version used for artifact naming
        required: true
        type: string
      arch:
        description: CPU architecture label used in artifact naming
        required: false
        default: x64
        type: string

jobs:
  build:
    runs-on: windows-latest
    env:
      APP_VERSION: ${{ inputs.version }}
      TARGET_ARCH: ${{ inputs.arch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: 获取依赖
        shell: pwsh
        run: flutter pub get
      - name: 安装 WiX Toolset
        shell: pwsh
        run: choco install wixtoolset --no-progress -y
      - name: 构建 Windows 应用
        shell: pwsh
        run: flutter build windows --release
      - name: 构建 Windows MSI 安装包
        shell: pwsh
        run: |
          $artifactDir = "build/artifacts"
          $buildDir = "build/windows/$env:TARGET_ARCH/runner/Release"
          if (-not (Test-Path $buildDir)) {
            Write-Error "未找到 Windows 构建输出：$buildDir"
          }

          New-Item -ItemType Directory -Path $artifactDir -Force | Out-Null
          $buildDir = (Resolve-Path $buildDir).Path
          $artifactDir = (Resolve-Path $artifactDir).Path

          $wixBinCandidates = @(
            Join-Path "${env:ProgramFiles(x86)}" "WiX Toolset v3.11\bin",
            Join-Path "${env:ProgramFiles(x86)}" "WiX Toolset v3.14\bin",
            Join-Path "${env:ProgramFiles}" "WiX Toolset v3.11\bin",
            Join-Path "${env:ProgramFiles}" "WiX Toolset v3.14\bin"
          ) | Where-Object { Test-Path $_ }

          $wixBin = $wixBinCandidates | Select-Object -First 1
          if (-not $wixBin) {
            $candleCmd = Get-Command candle.exe -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($candleCmd) {
              $wixBin = Split-Path $candleCmd.Path
            }
          }

          if (-not $wixBin) {
            $searchRoots = @("C:\Program Files (x86)", "C:\Program Files", "C:\ProgramData\chocolatey\lib")
            $candleExe = $searchRoots |
              ForEach-Object {
                Get-ChildItem -Path $_ -Filter "candle.exe" -File -Recurse -ErrorAction SilentlyContinue -Depth 4 |
                  Select-Object -First 1
              } | Select-Object -First 1
            if ($candleExe) {
              $wixBin = Split-Path $candleExe.FullName
            }
          }

          if (-not $wixBin) {
            Write-Error "未找到 WiX 工具目录，请检查 wixtoolset 是否安装成功"
          }

          Write-Host "使用 WiX 工具目录：$wixBin"

          $heat = Join-Path $wixBin "heat.exe"
          $candle = Join-Path $wixBin "candle.exe"
          $light = Join-Path $wixBin "light.exe"

          $appFilesWxs = Join-Path $env:RUNNER_TEMP "AppFiles.wxs"
          $productWxs = Join-Path $env:RUNNER_TEMP "Product.wxs"
          $outputBaseName = "windows-$($env:TARGET_ARCH)-$($env:APP_VERSION)-setup"

          $platform = switch ($env:TARGET_ARCH.ToLowerInvariant()) {
            "x86" { "x86" }
            default { "x64" }
          }
          $programFilesDir = if ($platform -eq "x86") { "ProgramFilesFolder" } else { "ProgramFiles64Folder" }

          & $heat dir $buildDir -dr APPLICATIONFOLDER -cg AppFiles -gg -srd -sreg -out $appFilesWxs -var "var.BuildDir"

          $productContent = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="Misuzu Music" Language="1033" Version="${env:APP_VERSION}" Manufacturer="Misuzu" UpgradeCode="5F8F1E2F-9F8E-4F44-BEC6-4833F8D66FF6">
              <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" InstallPrivileges="elevated" Platform="$platform" />
              <MajorUpgrade DowngradeErrorMessage="已安装更高版本的 Misuzu Music。" />
              <MediaTemplate EmbedCab="yes" />

              <Feature Id="MainFeature" Title="Misuzu Music" Level="1">
                <ComponentGroupRef Id="AppFiles" />
                <ComponentRef Id="ApplicationShortcutStartMenu" />
                <ComponentRef Id="ApplicationShortcutDesktop" />
              </Feature>

              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="$programFilesDir">
                  <Directory Id="APPLICATIONFOLDER" Name="Misuzu Music" />
                </Directory>
                <Directory Id="ProgramMenuFolder">
                  <Directory Id="ApplicationProgramsFolder" Name="Misuzu Music" />
                </Directory>
                <Directory Id="DesktopFolder" />
              </Directory>

              <DirectoryRef Id="ApplicationProgramsFolder">
                <Component Id="ApplicationShortcutStartMenu" Guid="B56D13BE-1D42-44F0-97BB-87B5A5296A60">
                  <Shortcut Id="StartMenuShortcut" Name="Misuzu Music" Target="[APPLICATIONFOLDER]MisuzuMusic.exe" WorkingDirectory="APPLICATIONFOLDER" />
                  <RemoveFolder Id="RemoveApplicationProgramsFolder" On="uninstall" />
                  <RegistryValue Root="HKLM" Key="Software\MisuzuMusic" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </DirectoryRef>

              <DirectoryRef Id="DesktopFolder">
                <Component Id="ApplicationShortcutDesktop" Guid="1D92C3A2-4658-4A8B-8718-03BAFA0BC2E4">
                  <Shortcut Id="DesktopShortcut" Name="Misuzu Music" Target="[APPLICATIONFOLDER]MisuzuMusic.exe" WorkingDirectory="APPLICATIONFOLDER" />
                  <RegistryValue Root="HKLM" Key="Software\MisuzuMusic" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </DirectoryRef>
            </Product>
          </Wix>
          "@
          $productContent | Set-Content -Path $productWxs -Encoding UTF8

          Push-Location $env:RUNNER_TEMP
          & $candle -nologo -arch $platform -dBuildDir="$buildDir" $appFilesWxs $productWxs
          & $light -nologo -out (Join-Path $artifactDir "$outputBaseName.msi") AppFiles.wixobj Product.wixobj
          Pop-Location
      - name: 打包 ZIP
        shell: pwsh
        run: |
          $artifactDir = "build/artifacts"
          New-Item -ItemType Directory -Path $artifactDir -Force | Out-Null
          $buildDir = "build/windows/$env:TARGET_ARCH/runner/Release"
          if (-not (Test-Path $buildDir)) {
            Write-Error "未找到 Windows 构建输出：$buildDir"
          }
          $artifactName = "windows-$($env:TARGET_ARCH)-$($env:APP_VERSION).zip"
          $destination = Join-Path $artifactDir $artifactName
          if (Test-Path $destination) {
            Remove-Item $destination -Force
          }
          Compress-Archive -Path (Join-Path $buildDir '*') -DestinationPath $destination -Force
      - name: 上传 Windows 安装程序
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.TARGET_ARCH }}-${{ env.APP_VERSION }}-setup.msi
          path: build/artifacts/windows-${{ env.TARGET_ARCH }}-${{ env.APP_VERSION }}-setup.msi
          if-no-files-found: error
      - name: 上传 Windows 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.TARGET_ARCH }}-${{ env.APP_VERSION }}.zip
          path: build/artifacts/windows-${{ env.TARGET_ARCH }}-${{ env.APP_VERSION }}.zip
          if-no-files-found: error
